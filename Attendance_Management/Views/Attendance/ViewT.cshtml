@model List<Attendance_Management.Controllers.teacherlist>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/css/attendance.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <title>Dashboard</title>
</head>
<body>
    <div class="header">
        <div class="hamburger" id="hamburger">
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div class="info">
            <p id="t_name"></p>
        </div>
    </div>
    <div class="main">
        <div class="side">
            <div class="side-items">
                <span class="side-head"><a asp-controller="Login" asp-action="dashboardT">Teacher Portal</a></span>
                <span><i class="fas fa-calendar-check"></i><a asp-controller="Attendance" asp-action="attendanceT">Mark Attendance</a></span>
                <span><i class="fas fa-key"></i><a asp-controller="Password" asp-action="PasswordChangingT">Change Password</a></span>
                <span><i class="fas fa-table"></i><a asp-controller="Timetable" asp-action="ShowTimetableT">View Timetable</a></span>
                <span><i class="fa-solid fa-registered"></i><a asp-controller="Attendance" asp-action="ViewT">View Attendance</a></span>
                <span><i class="fa-solid fa-right-from-bracket"></i><a asp-controller="Login" asp-action="Logout">Logout</a></span>
            </div>
        </div>

        <div class="main-body">
            <div class="selection">

                <!-- Program -->
                <div>
                    <label>Select Program</label>
                    <select id="programSelect">
                        <option value="">Select Program</option>
                        @foreach (var program in Model
                        .GroupBy(x => x.Program_id)
                        .Select(g => g.First()))
                        {
                            <option value="@program.Program_id">@program.Program_name</option>
                        }
                    </select>
                </div>

                <!-- Course -->
                <div>
                    <label>Select Subject</label>
                    <select id="courseSelect">
                        <option value="">Select Course</option>
                        @* Initially empty; populated based on selected program *@
                    </select>
                </div>

                <!-- Session -->
                <div>
                    <label>Select Session</label>
                    <select id="sessionSelect">
                        <option value="">Select Session</option>
                    </select>
                </div>

                <!-- Section -->
                <div>
                    <label>Select Section</label>
                    <select id="sectionSelect">
                        <option value="">Select Section</option>
                    </select>
                </div>

                <div class="show-btn printing">
                    <button id="showStudentsBtn">Show Students</button>
                </div>
            </div>

            <!-- Students Attendance Table -->
            <div class="students-table" id="studentsTable" style="display:none">
                <table>
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Student Name</th>
                            <th>Average Attendance (%)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentsBody"></tbody>
                </table>
            </div>
            <div class="modal fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Attendance Record</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceRecordBody"></tbody>
                            </table>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">
                                Close
                            </button>
                        </div>

                    </div>
                </div>
            </div>
            <div class="custom-alert" id="loginAlert" style="display:none">
                <i class="fas fa-exclamation-circle"></i>
                <span id="alertMessage"></span>
                <button onclick="closeAlert()">×</button>
            </div>


        </div>
    </div>
</body>

<script>
    // Fetch teacher name
    fetch('/Login/data')
        .then(res => res.text())
        .then(data => { document.getElementById('t_name').innerHTML = data });

    const hamburger = document.getElementById("hamburger");
    const sidebar = document.querySelector(".side");
    hamburger.addEventListener("click", () => {
        sidebar.classList.toggle("active");
        document.body.classList.toggle("sidebar-open");
    });
</script>
<script>
    const modelData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

    const programSelect = document.getElementById("programSelect");
    const courseSelect = document.getElementById("courseSelect");
    const sessionSelect = document.getElementById("sessionSelect");
    const sectionSelect = document.getElementById("sectionSelect");

    function resetSelect(select, placeholder) {
        select.innerHTML = `<option value="">${placeholder}</option>`;
    }

    // Program → Courses
    programSelect.addEventListener("change", function () {
        const pid = this.value;
        resetSelect(courseSelect, "Select Course");
        resetSelect(sessionSelect, "Select Session");
        resetSelect(sectionSelect, "Select Section");

        if (!pid) return;

        const courses = modelData
            .filter(x => x.Program_id == pid)
            .filter((v, i, a) => a.findIndex(t => t.Course_id === v.Course_id) === i);

        courses.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.Course_id;
            opt.text = c.Course_name;
            courseSelect.appendChild(opt);
        });
    });

    // Course → Sessions
    courseSelect.addEventListener("change", function () {
        const pid = programSelect.value;
        const courseId = this.value;
        resetSelect(sessionSelect, "Select Session");
        resetSelect(sectionSelect, "Select Section");

        if (!pid || !courseId) return;

        const sessions = modelData
            .filter(x => x.Program_id == pid && x.Course_id == courseId)
            .filter((v, i, a) => a.findIndex(t => t.Session_id === v.Session_id) === i);

        sessions.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.Session_id;
            opt.text = s.Session_name;
            sessionSelect.appendChild(opt);
        });
    });

    // Session → Sections
    sessionSelect.addEventListener("change", function () {
        const pid = programSelect.value;
        const courseId = courseSelect.value;
        const sessionId = this.value;
        resetSelect(sectionSelect, "Select Section");

        if (!pid || !courseId || !sessionId) return;

        const sections = modelData
            .filter(x => x.Program_id == pid && x.Course_id == courseId && x.Session_id == sessionId)
            .filter((v, i, a) => a.findIndex(t => t.Section_id === v.Section_id) === i);

        sections.forEach(sec => {
            const opt = document.createElement("option");
            opt.value = sec.Section_id;
            opt.text = sec.Section_name;
            sectionSelect.appendChild(opt);
        });
    });
            let attendanceModal;

    function viewAttendance(studentId) {
        const cid = courseSelect.value;

        fetch(`/Attendance/GetStudentAttendanceRecord?studentId=${studentId}&cid=${cid}`)
            .then(res => res.json())
            .then(data => {
                const body = document.getElementById("attendanceRecordBody");
                body.innerHTML = "";

                if (data.length === 0) {
                    body.innerHTML = `
                        <tr>
                            <td colspan="2" class="text-center">
                                No attendance record found
                            </td>
                        </tr>`;
                } else {
                    data.forEach(r => {
                        body.innerHTML += `
                            <tr>
                                <td>${r.date}</td>
                                <td>
                                    <span class="badge ${r.status === "Present" ? "bg-success" : "bg-danger"}">
                                        ${r.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                }

                attendanceModal = new bootstrap.Modal(
                    document.getElementById("attendanceModal")
                );
                attendanceModal.show();
            });
    }



</script>
<script>
    function showAlert(message, type = "danger") {
        const alertBox = document.getElementById("loginAlert");
        const alertMessage = document.getElementById("alertMessage");

        // reset classes
        alertBox.classList.remove("success");

        // apply success if needed
        if (type === "success") {
            alertBox.classList.add("success");
        }

        alertMessage.innerText = message;
        alertBox.style.display = "flex";

        setTimeout(() => {
            alertBox.style.display = "none";
        }, 4000);
    }

    function closeAlert() {
        document.getElementById("loginAlert").style.display = "none";
    }
</script>


<script>
    const showStudentsBtn = document.getElementById("showStudentsBtn");
    const studentsTable = document.getElementById("studentsTable");
    const studentsBody = document.getElementById("studentsBody");

            showStudentsBtn.addEventListener("click", function () {
        const pid = programSelect.value;
        const cid = courseSelect.value;
        const sid = sessionSelect.value;
        const secid = sectionSelect.value;

            if (!pid || !cid || !sid || !secid) {
        showAlert("Please select all fields","danger");
        return;
    }


        fetch(`/Attendance/FetchRegisteredStudents?pid=${pid}&cid=${cid}&sid=${sid}&secid=${secid}`)
            .then(res => res.json())
            .then(data => {
                studentsBody.innerHTML = "";

                if (data.length === 0) {
                    studentsBody.innerHTML =
                        `<tr><td colspan="4">No students found</td></tr>`;
                    studentsTable.style.display = "block";
                    return;
                }

                data.forEach(s => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${s.rollNumber}</td>
                        <td>${s.studentName}</td>
                        <td>${s.averageAttendance}%</td>
                        <td>
                        <div class="printing">
                            <button onclick="viewAttendance(${s.studentId})">
                                View Attendance
                            </button>
                        </div>
                        </td>
                    `;
                    studentsBody.appendChild(row);
                });

                studentsTable.style.display = "block";
            });
    });


    
</script>
<script src="~/lib/bootstrap/dist/js/bootstrap.min.js"></script>

</html>
