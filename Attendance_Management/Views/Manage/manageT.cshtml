@model Attendance_Management.Controllers.ManageTeacherVM
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/manage.css" asp-append-version="true" />
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <title>Manage Teacher</title>
</head>

<body>

    <input type="hidden" id="selectedTeacherId" />
    <input type="hidden" id="selectedProgramId" />
    <input type="hidden" id="selectedSessionId" />
    <input type="hidden" id="selectedCourseId" />

    <div class="header">
        <div class="hamburger" id="hamburger">
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div class="info">
            <p>Admin Name</p>
        </div>
    </div>
    <div class="main">
        <div class="side">
            <div class="side-items">
                <span class="side-head"><a asp-controller="Login" asp-action="dashboardA">Admin Portal</a></span>
                <span><i class="fas fa-chalkboard-teacher"></i><a asp-controller="Manage" asp-action="manageT">Manage Teachers</a></span>
                <span><i class="fas fa-book"></i><a asp-controller="Manage" asp-action="manageS">Manage Student</a></span>
                <span><i class="fas fa-id-badge"></i><a asp-controller="Manage" asp-action="managebadge">Manage Badge</a></span>
                <span><i class="fas fa-users"></i><a asp-controller="Manage" asp-action="managesection">Manage Section</a></span>
                <span><i class="fas fa-key"></i><a asp-controller="Password" asp-action="PasswordChangingA">Change Password</a></span>
                <span><i class="fas fa-table"></i><a asp-controller="Timetable" asp-action="ShowTimetableA">View Timetable</a></span>
                <span><i class="fa-solid fa-right-from-bracket"></i><a asp-controller="Login" asp-action="Logout">Logout</a></span>
            </div>
        </div>
        <div class="main-body">
            <!-- Search + Add -->
            <div class="functions row g-3">
                <div class="col-12 col-md-9 col-lg-9">
                    <input type="text" class="search" id="searchBox" placeholder="Search Teacher..." />
                </div>
                <div class="col-12 col-md-3 col-lg-3">
                    <button data-bs-toggle="modal" data-bs-target="#myModal">Add Teacher</button>
                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="no-results">
                <p>No teacher found with that name.</p>
            </div>

            <!-- Search Results Table -->
            <div id="searchResult" style="display: none" class="dummy">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Assign Course</th>
                            <th>Delete Teacher</th>
                        </tr>
                    </thead>
                    <tbody id="teacherBody"></tbody>
                </table>
            </div>

            <!-- Add Teacher Modal -->
            <div class="modal" id="myModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <!-- Modal Header -->
                        <div class="modal-header">
                            <h3 class="modal-title">Add Teacher</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <!-- Modal body -->
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Teacher Name</label>
                                <input type="text" class="form-control" id="teacherName" />
                            </div>

                            <div class="printing">
                                <button data-bs-dismiss="modal" onclick="addTeacher()">Add Teacher</button>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assign Course Modal -->
            <!-- Assign Course Modal -->
            <div class="modal" id="myModal2">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <!-- Modal Header -->
                        <div class="modal-header">
                            <h3 class="modal-title">Assign Course</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <!-- Modal body -->
                        <div class="modal-body">
                            <!-- Note: No hidden field here - using the one at the top of the page -->

                            <div class="mb-3">
                                <label class="form-label">Select Program</label>
                                <select class="form-select" id="programSelect" onchange="loadSessions()">
                                    <option value="">Select Program</option>
                                    @foreach (var p in Model.Programs)
                                    {
                                        <option value="@p.ProgramId">@p.ProgramName</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Select Session</label>
                                <select class="form-select" id="sessionSelect" onchange="loadCourses()">
                                    <option value="">Select Session</option>
                                    @foreach (var s in Model.Sessions)
                                    {
                                        <option value="@s.SessionId" data-program="@s.ProgramId">@s.SessionName</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Select Course</label>
                                <select class="form-select" id="courseSelect">
                                    <option value="">Select Course</option>
                                    <!-- Courses will be loaded dynamically -->
                                </select>
                            </div>

                            <div class="custom-alert" id="loginAlert" style="display:none">
                                <i class="fas fa-exclamation-circle"></i>
                                <span id="alertMessage"></span>
                                <button onclick="closeAlert()">×</button>
                            </div>

                            <div class="printing">
                                <button onclick="assignCourse()" data-bs-dismiss="modal">Assign</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
                function showAlert(message, type = "danger") {
                const alertBox = document.getElementById("loginAlert");
                const alertMessage = document.getElementById("alertMessage");

                // reset classes
                alertBox.classList.remove("success");

                // apply success if needed
                if (type === "success") {
                    alertBox.classList.add("success");
                }

                alertMessage.innerText = message;
                alertBox.style.display = "flex";

                setTimeout(() => {
                    alertBox.style.display = "none";
                }, 4000);
            }

            function closeAlert() {
                document.getElementById("loginAlert").style.display = "none";
            }
        </script>
        <script src="~/lib/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="~/lib/jquery/dist/jquery.min.js"></script>

        <script>
            // Sidebar toggle
            const hamburger = document.getElementById("hamburger");
            const sidebar = document.querySelector(".side");
            hamburger.addEventListener("click", () => {
                sidebar.classList.toggle("active");
            });

            // Variables to store current search data
            let currentSearchTerm = '';
            let currentTeachers = [];

            // Search functionality
            const searchBox = document.getElementById("searchBox");
            const resultDiv = document.getElementById("searchResult");
            const noResultsDiv = document.getElementById("noResults");
            const teacherBody = document.getElementById("teacherBody");

            searchBox.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    currentSearchTerm = searchBox.value.trim();
                    if (currentSearchTerm !== "") {
                        searching();
                    } else {
                        hideAllResults();
                    }
                }
            });

            function hideAllResults() {
                resultDiv.style.display = "none";
                noResultsDiv.style.display = "none";
            }

            function showNoResults() {
                resultDiv.style.display = "none";
                noResultsDiv.style.display = "block";
            }

            function showResults() {
                resultDiv.style.display = "block";
                noResultsDiv.style.display = "none";
            }

            async function addTeacher() {
                const name = document.getElementById("teacherName").value.trim();

                if (name === "") {
                    showAlert("Please enter teacher name","danger");
                    return;
                }

                try {
                    const response = await fetch('/Manage/Addteacher', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `name=${encodeURIComponent(name)}`
                    });

                    const data = await response.text();

                    if (data === "Ok") {
                        showAlert("Teacher added successfully","success");
                        document.getElementById("teacherName").value = "";

                        // If there's a current search, refresh the results
                        if (currentSearchTerm !== "") {
                            await searching();
                        }
                    } else {
                        showAlert("Error adding teacher","danger");
                    }
                } catch (error) {
                    console.error('Error adding teacher:', error,"danger");
                    showAlert("Error adding teacher","danger");
                }
            }

            async function searching() {
                const name = document.getElementById("searchBox").value.trim();
                if (name === "") {
                    hideAllResults();
                    return;
                }

                try {
                    const response = await fetch('/Manage/SearchTeacher', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `name=${encodeURIComponent(name)}`
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    currentTeachers = data || [];

                    renderTeacherTable(currentTeachers);

                } catch (error) {
                    console.error('Error searching teachers:', error);
                    showNoResults();
                }
            }

            function renderTeacherTable(teachers) {
                teacherBody.innerHTML = "";

                if (!teachers || teachers.length === 0) {
                    showNoResults();
                    return;
                }

                showResults();

                // Check if it's a single teacher object or array
                if (!Array.isArray(teachers)) {
                    // Single teacher (old format)
                    const row = createTeacherRow(teachers);
                    teacherBody.appendChild(row);
                } else {
                    // Array of teachers (new format)
                    teachers.forEach(teacher => {
                        const row = createTeacherRow(teacher);
                        teacherBody.appendChild(row);
                    });
                }
            }

            function createTeacherRow(teacher) {
                const row = document.createElement("tr");
                row.id = `teacher-row-${teacher.teacherId}`;
                row.innerHTML = `
                    <td>${teacher.teachername || ''}</td>
                    <td>${teacher.username || ''}</td>
                    <td>${teacher.password || ''}</td>
                    <td>
                        <button class="assign-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#myModal2"
                                onclick="setTeacherId(${teacher.teacherId})">
                            Assign
                        </button>
                    </td>
                    <td>
                        <button class="delete-btn" onclick="deleteTeacher(${teacher.teacherId}, '${teacher.teachername || ''}')">
                            Delete
                        </button>
                    </td>
                `;
                return row;
            }

            function setTeacherId(id) {
                document.getElementById("selectedTeacherId").value = id;
            }

            async function assignCourse() {
                const teacherId = document.getElementById("selectedTeacherId").value;
                const sessionId = document.getElementById("sessionSelect").value;
                const courseId = document.getElementById("courseSelect").value;

                if (!teacherId || !sessionId || !courseId) {
                    showAlert("Please select all fields","danger");
                    return;
                }

                try {
                    const response = await fetch('/Manage/AssigncourseT', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `pkid=${teacherId}&cid=${courseId}&sid=${sessionId}`
                    });

                    const result = await response.text();

                    if (result === "Ok") {
                        showAlert("Assigned successfully","success");
                        // Reset modal selections
                        document.getElementById("programSelect").value = "";
                        document.getElementById("sessionSelect").value = "";
                        document.getElementById("courseSelect").value = "";
                    } else {
                        showAlert(result || "Error assigning course","danger");
                    }
                } catch (error) {
                    console.error('Error assigning course:', error,"danger");
                    showAlert("Error assigning course","danger");
                }
            }

            async function deleteTeacher(id, teacherName) {
                if (!confirm(`Are you sure you want to delete teacher: ${teacherName || 'this teacher'}?`)) {
                    return;
                }

                try {
                    const response = await fetch('/Manage/DeleteTeacher', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `pkid=${id}`
                    });

                    const result = await response.text();

                    if (result === "Ok") {
                        // Remove the teacher row from the table
                        const rowToRemove = document.getElementById(`teacher-row-${id}`);
                        if (rowToRemove) {
                            rowToRemove.remove();
                        }

                        // Update currentTeachers array
                        currentTeachers = currentTeachers.filter(teacher => teacher.teacherId !== id);

                        // If no teachers left, show no results message
                        if (currentTeachers.length === 0) {
                            showNoResults();
                        }

                        showAlert("Teacher deleted successfully","success");
                    } else {
                        showAlert(result || "Error deleting teacher","danger");
                    }
                } catch (error) {
                    console.error('Error deleting teacher:', error,"danger");
                    showAlert("Error deleting teacher","danger");
                }
            }

                        // Modal session/course loading functions
            function loadSessions() {
                const programId = document.getElementById("programSelect").value;
                const sessionSelect = document.getElementById("sessionSelect");
                const courseSelect = document.getElementById("courseSelect");

                // Reset all dependent dropdowns
                sessionSelect.innerHTML = '<option value="">Select Session</option>';
                sessionSelect.disabled = !programId;
                courseSelect.innerHTML = '<option value="">Select Course</option>';
                courseSelect.disabled = true;

                if (!programId) {
                    return;
                }

                // Filter sessions based on selected program from Model
                const allSessions = @Html.Raw(Json.Serialize(Model.Sessions));
                const filteredSessions = allSessions.filter(s => s.programId == programId);

                filteredSessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.sessionId;
                    option.textContent = session.sessionName;
                    sessionSelect.appendChild(option);
                });
            }

            function loadCourses() {
                const sessionId = document.getElementById("sessionSelect").value;
                const courseSelect = document.getElementById("courseSelect");

                // Reset course dropdown
                courseSelect.innerHTML = '<option value="">Select Course</option>';
                courseSelect.disabled = !sessionId;

                if (!sessionId) {
                    return;
                }

                // Load courses for the selected session
                loadCoursesForSession(sessionId);
            }

            async function loadCoursesForSession(sessionId) {
                const courseSelect = document.getElementById("courseSelect");
                courseSelect.innerHTML = '<option value="">Loading courses...</option>';
                courseSelect.disabled = true;

                try {
                    const response = await fetch(`/Manage/GetCoursesBySession?sessionId=${sessionId}`);
                    if (response.ok) {
                        const courses = await response.json();
                        courseSelect.innerHTML = '<option value="">Select Course</option>';

                        if (courses && courses.length > 0) {
                            courses.forEach(course => {
                                const option = document.createElement('option');
                                option.value = course.courseId;
                                option.textContent = course.courseName;
                                courseSelect.appendChild(option);
                            });
                            courseSelect.disabled = false;
                        } else {
                            courseSelect.innerHTML = '<option value="">No courses available</option>';
                        }
                    } else {
                        courseSelect.innerHTML = '<option value="">Error loading courses</option>';
                    }
                } catch (error) {
                    console.error('Error loading courses:', error);
                    courseSelect.innerHTML = '<option value="">Error loading courses</option>';
                }
            }

            async function assignCourse() {
                const teacherId = document.getElementById("selectedTeacherId").value;
                const programId = document.getElementById("programSelect").value;
                const sessionId = document.getElementById("sessionSelect").value;
                const courseId = document.getElementById("courseSelect").value;

                if (!teacherId || !programId || !sessionId || !courseId) {
                    showAlert("Please select all fields", "danger");
                    return;
                }

                try {
                    // Note: We're NOT sending sectionId anymore
                    const response = await fetch('/Manage/AssigncourseT', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `pkid=${teacherId}&cid=${courseId}&sid=${sessionId}`
                    });

                    const result = await response.text();

                    if (result === "Ok") {
                        showAlert("Course assigned successfully", "success");
                        // Reset modal selections
                        resetModalSelections();
                    } else if (result === "AlreadyAssigned") {
                        showAlert("This teacher is already assigned to this course", "danger");
                    } else {
                        showAlert(result || "Error assigning course", "danger");
                    }
                } catch (error) {
                    console.error('Error assigning course:', error);
                    showAlert("Error assigning course", "danger");
                }
            }

            function resetModalSelections() {
                document.getElementById("programSelect").value = "";
                document.getElementById("sessionSelect").value = "";
                document.getElementById("courseSelect").innerHTML = '<option value="">Select Course</option>';
                document.getElementById("courseSelect").disabled = true;
            }// This matches your existing backend's AssigncourseT method signature
        </script>
</body>
</html>