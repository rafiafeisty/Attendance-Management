@model Attendance_Management.Controllers.ManageTeacherVM
@{
    ViewData["Title"] = "Manage Badge";
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/manage.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Manage Badge</title>
    <style>
        .search-result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom: 30px;
        }

            .search-result-table th,
            .search-result-table td {
                border: 1px solid #ddd;
                padding: 12px;
                text-align: left;
            }

            .search-result-table th {
                background-color: #f2f2f2;
                font-weight: bold;
            }

            .search-result-table tr:hover {
                background-color: #f5f5f5;
            }

        .badge-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: white;
        }

        .badge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .badge-title {
            color: #007bff;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .badge-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .stat-box {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            text-align: center;
            min-width: 120px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .sections-container {
            margin-top: 15px;
        }

        .section-item {
            background-color: #e9f7fe;
            border: 1px solid #b8e0fc;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-name {
            font-weight: bold;
            color: #0056b3;
        }

        .section-count {
            background-color: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

            .delete-btn:hover {
                background-color: #c82333;
            }

        .error-message {
            color: #dc3545;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }

        .success-message {
            color: #28a745;
            margin-top: 10px;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
        }

        .modal-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-top: 20px;
        }

        .file-upload {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 15px 0;
        }

            .file-upload:hover {
                border-color: #007bff;
            }

        .badge-search-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

            .badge-search-btn:hover {
                background-color: #138496;
            }
    </style>
</head>

<body>
    <div class="header">
        <div class="hamburger" id="hamburger">
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div class="info">
            <p>Admin Name</p>
        </div>
    </div>
    <div class="main">
        <div class="side">
            <div class="side-items">
                <span class="side-head"><a asp-controller="Login" asp-action="dashboardA">Admin Portal</a></span>
                <span><i class="fas fa-chalkboard-teacher"></i><a asp-controller="Manage" asp-action="manageT">Manage Teachers</a></span>
                <span><i class="fas fa-book"></i><a asp-controller="Manage" asp-action="manageS">Manage Student</a></span>
                <span><i class="fas fa-id-badge"></i><a asp-controller="Manage" asp-action="managebadge">Manage Badge</a></span>
                <span><i class="fas fa-users"></i><a asp-controller="Manage" asp-action="managesection">Manage Section</a></span>
                <span><i class="fas fa-key"></i><a asp-controller="Password" asp-action="PasswordChangingA">Change Password</a></span>
                <span><i class="fas fa-table"></i><a asp-controller="Timetable" asp-action="ShowTimetableA">View Timetable</a></span>
                <span><i class="fa-solid fa-right-from-bracket"></i><a asp-controller="Login" asp-action="Logout">Logout</a></span>
            </div>
        </div>
        <div class="main-body">
            <!-- Search + Add -->
            <div class="functions row g-3">
                <div class="col-12 col-md-9 col-lg-9">
                    <input type="text" class="search" id="searchBox" placeholder="Search by Badge/Year (e.g., 2023, 2024)..." />
                </div>
                <div class="col-12 col-md-3 col-lg-3">
                    <button class="badge-search-btn action-btn" data-bs-toggle="modal" data-bs-target="#addBadgeModal">
                        <i class="fas fa-plus-circle"></i> Create New Badge
                    </button>
                </div>
            </div>
            <div class="custom-alert" id="loginAlert" style="display:none">
                <i class="fas fa-exclamation-circle"></i>
                <span id="alertMessage"></span>
                <button onclick="closeAlert()">×</button>
            </div>
            <!-- No Results Message -->
            <div id="noResults" class="no-results">
                <p>No badges found. Create a new badge to get started.</p>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner" style="display: none;"></div>

            <!-- Search Results Container -->
            <div id="searchResult" style="display: none" class="dummy">
                <div id="badgeResultsContainer">
                    <!-- Badge results will be populated here -->
                </div>
            </div>

            <!-- Students View Container -->
            <div id="studentsView" style="display: none">
                <button class="back-btn" onclick="showBadgeList()">
                    <i class="fas fa-arrow-left"></i> Back to Badge List
                </button>
                <h3 id="studentsViewTitle" style="color: var(--primary-color); margin-bottom: 20px;"></h3>
                <div id="studentsContainer">
                    <!-- Students table will be populated here -->
                </div>
            </div>

            <!-- Add Badge Modal -->
            <div class="modal fade" id="addBadgeModal" tabindex="-1" aria-labelledby="addBadgeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addBadgeModalLabel">Create New Badge</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="addBadgeMessage" class="modal-message"></div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Select Program</label>
                                    <select class="form-select" id="badgeProgramSelect">
                                        <option value="">Select Program</option>
                                        @foreach (var p in Model.Programs)
                                        {
                                            <option value="@p.ProgramId">@p.ProgramName</option>
                                        }
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Badge/Year</label>
                                    <input type="text" class="form-control" id="badgeName"
                                           placeholder="e.g., 2023, 2024, Fall 2024" />
                                    <small class="text-muted">Enter the badge name (usually the year)</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Number of Sections</label>
                                    <input type="number" class="form-control" id="numberOfSections"
                                           min="1" max="10" value="4" placeholder="e.g., 4" />
                                    <small class="text-muted">Number of sections to create (B1, B2, B3...)</small>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Upload Student List</label>
                                    <div class="file-upload">
                                        <input type="file" class="form-control" id="badgeExcelFile" accept=".xlsx, .xls" />
                                        <small class="text-muted">Upload Excel file with student names in column A (first row is header)</small>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                This will create a new badge (session) with the specified number of sections (B1, B2, B3...).
                                Students will be evenly distributed across sections and will get unique roll numbers and credentials.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="createBadge()">
                                <i class="fas fa-plus-circle"></i> Create Badge
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
            function showAlert(message, type = "danger") {
            const alertBox = document.getElementById("loginAlert");
            const alertMessage = document.getElementById("alertMessage");

            // reset classes
            alertBox.classList.remove("success");

            // apply success if needed
            if (type === "success") {
                alertBox.classList.add("success");
            }

            alertMessage.innerText = message;
            alertBox.style.display = "flex";

            setTimeout(() => {
                alertBox.style.display = "none";
            }, 4000);
        }

        function closeAlert() {
            document.getElementById("loginAlert").style.display = "none";
        }
    </script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script>
        // Sidebar toggle
        const hamburger = document.getElementById("hamburger");
        const sidebar = document.querySelector(".side");
        hamburger.addEventListener("click", () => {
            sidebar.classList.toggle("active");
        });

        let currentSearchTerm = '';
        let currentView = 'badges'; // 'badges' or 'students'

        const searchBox = document.getElementById("searchBox");
        const resultDiv = document.getElementById("searchResult");
        const studentsViewDiv = document.getElementById("studentsView");
        const noResultsDiv = document.getElementById("noResults");
        const badgeResultsContainer = document.getElementById("badgeResultsContainer");
        const studentsContainer = document.getElementById("studentsContainer");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const studentsViewTitle = document.getElementById("studentsViewTitle");

        searchBox.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                currentSearchTerm = searchBox.value.trim();
                if (currentSearchTerm !== "") {
                    searchBadges();
                } else {
                    hideAllResults();
                }
            }
        });

        // Also search on input with debounce
        let searchTimeout;
        searchBox.addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchTerm = searchBox.value.trim();
                if (currentSearchTerm !== "") {
                    searchBadges();
                } else {
                    hideAllResults();
                }
            }, 500);
        });

        function hideAllResults() {
            resultDiv.style.display = "none";
            studentsViewDiv.style.display = "none";
            noResultsDiv.style.display = "block";
            loadingSpinner.style.display = "none";
            currentView = 'badges';
        }

        function showNoResults() {
            resultDiv.style.display = "none";
            studentsViewDiv.style.display = "none";
            noResultsDiv.style.display = "block";
            loadingSpinner.style.display = "none";
        }

        function showLoading() {
            resultDiv.style.display = "none";
            studentsViewDiv.style.display = "none";
            noResultsDiv.style.display = "none";
            loadingSpinner.style.display = "block";
        }

        function showBadgeResults() {
            resultDiv.style.display = "block";
            studentsViewDiv.style.display = "none";
            noResultsDiv.style.display = "none";
            loadingSpinner.style.display = "none";
            currentView = 'badges';
        }

        function showStudentsView() {
            resultDiv.style.display = "none";
            studentsViewDiv.style.display = "block";
            noResultsDiv.style.display = "none";
            loadingSpinner.style.display = "none";
            currentView = 'students';
        }

        async function searchBadges() {
            showLoading();
            const searchTerm = document.getElementById("searchBox").value.trim();
            if (!searchTerm) {
                hideAllResults();
                return;
            }

            try {
                const response = await fetch('/Manage/SearchBadge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `name=${encodeURIComponent(searchTerm)}`
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const badges = await response.json();
                renderBadgeResults(badges || []);
            } catch (error) {
                console.error('Search error:', error);
                showNoResults();
            }
        }

        function renderBadgeResults(badges) {
            badgeResultsContainer.innerHTML = "";

            if (!badges || badges.length === 0) {
                showNoResults();
                return;
            }

            showBadgeResults();

            badges.forEach(badge => {
                const badgeCard = document.createElement("div");
                badgeCard.className = "badge-card";
                badgeCard.id = `badge-${badge.sessionId}`;

                // Header with title and actions
                const header = document.createElement("div");
                header.className = "badge-header";
                header.innerHTML = `
                    <div class="badge-title">
                        ${badge.programName} - ${badge.sessionName}
                    </div>
                `;

                // Stats row
                const stats = document.createElement("div");
                stats.className = "badge-stats";
                stats.innerHTML = `
                    <div class="stat-box">
                        <div class="stat-value">${badge.sectionCount}</div>
                        <div class="stat-label">Sections</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${badge.studentCount}</div>
                        <div class="stat-label">Students</div>
                    </div>
                `;

                // Sections list
                const sectionsContainer = document.createElement("div");
                sectionsContainer.className = "sections-container";

                if (badge.sections && badge.sections.length > 0) {
                    const sectionsTitle = document.createElement("h6");
                    sectionsTitle.textContent = "Sections:";
                    sectionsTitle.style.marginBottom = "10px";
                    sectionsTitle.style.color = "var(--primary-color)";
                    sectionsContainer.appendChild(sectionsTitle);

                    badge.sections.forEach(section => {
                        const sectionItem = document.createElement("div");
                        sectionItem.className = "section-item";
                        sectionItem.innerHTML = `
                            <span class="section-name">${section.sectionName}</span>
                            <span class="section-count">${section.studentCount} students</span>
                        `;
                        sectionsContainer.appendChild(sectionItem);
                    });
                } else {
                    const noSections = document.createElement("div");
                    noSections.className = "alert alert-warning";
                    noSections.textContent = "No sections found for this badge.";
                    sectionsContainer.appendChild(noSections);
                }

                // Action buttons
                const actions = document.createElement("div");
                actions.className = "badge-actions";
                actions.innerHTML = `
                    <button class="action-btn view-btn" onclick="viewStudents(${badge.sessionId}, '${badge.programName} - ${badge.sessionName}')">
                        <i class="fas fa-eye"></i> View Students
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteBadge(${badge.sessionId}, '${badge.sessionName}')">
                        <i class="fas fa-trash"></i> Delete Badge
                    </button>
                `;

                badgeCard.appendChild(header);
                badgeCard.appendChild(stats);
                badgeCard.appendChild(sectionsContainer);
                badgeCard.appendChild(actions);
                badgeResultsContainer.appendChild(badgeCard);
            });
        }

        async function viewStudents(sessionId, badgeName) {
            showLoading();
            
            try {
                const response = await fetch('/Manage/GetStudentsByBadge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `sessionId=${sessionId}`
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const students = await response.json();
                renderStudentsTable(students, badgeName);
            } catch (error) {
                console.error('Error fetching students:', error);
                showAlert('Error loading students. Please try again.',"danger");
                showBadgeResults();
            }
        }

        function renderStudentsTable(students, badgeName) {
            studentsContainer.innerHTML = "";
            
            if (!students || students.length === 0) {
                studentsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        No students found for this badge.
                    </div>
                `;
                studentsViewTitle.textContent = badgeName;
                showStudentsView();
                return;
            }

            // Group students by section
            const groupedStudents = {};
            students.forEach(student => {
                if (!groupedStudents[student.sectionName]) {
                    groupedStudents[student.sectionName] = [];
                }
                groupedStudents[student.sectionName].push(student);
            });

            // Create table
            let tableHTML = `
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Student Name</th>
                            <th>Section</th>
                            <th>Username</th>
                            <th>Password</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Add students grouped by section
            Object.keys(groupedStudents).forEach(sectionName => {
                // Section header
                tableHTML += `
                    <tr class="section-header">
                        <td colspan="5">
                            <strong>${sectionName}</strong>
                            <span style="float: right; font-size: 0.9rem; color: var(--info);">
                                ${groupedStudents[sectionName].length} students
                            </span>
                        </td>
                    </tr>
                `;

                // Students in this section
                groupedStudents[sectionName].forEach(student => {
                    tableHTML += `
                        <tr class="student-row">
                            <td><strong>${student.rollNumber}</strong></td>
                            <td>${student.studentName}</td>
                            <td>${student.sectionName}</td>
                            <td class="credentials-cell">
                                ${student.username}
                                
                            </td>
                            <td class="credentials-cell">
                                ${student.password}
                                
                            </td>
                        </tr>
                    `;
                });
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            studentsContainer.innerHTML = tableHTML;
            studentsViewTitle.textContent = badgeName + " - Students List";
            showStudentsView();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show a temporary success message
                const originalText = event.target.innerHTML;
                event.target.innerHTML = '<i class="fas fa-check"></i>';
                event.target.style.color = 'var(--success)';
                
                setTimeout(() => {
                    event.target.innerHTML = originalText;
                    event.target.style.color = '';
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showAlert('Failed to copy to clipboard',"danger");
            });
        }

        function showBadgeList() {
            if (currentSearchTerm) {
                searchBadges();
            } else {
                hideAllResults();
            }
        }

                async function createBadge() {
            const programId = document.getElementById("badgeProgramSelect").value;
            const badgeName = document.getElementById("badgeName").value.trim();
            const numberOfSections = document.getElementById("numberOfSections").value;
            const fileInput = document.getElementById("badgeExcelFile");
            const messageDiv = document.getElementById("addBadgeMessage");

            messageDiv.innerHTML = '';
            messageDiv.className = 'modal-message';

            console.log('createBadge called with:', { programId, badgeName, numberOfSections, file: fileInput.files });

            // Validation
            if (!programId || !badgeName) {
                messageDiv.innerHTML = 'Please select program and enter badge name';
                messageDiv.className = 'modal-message error-message';
                console.log('Validation failed: Missing program or badge name');
                return;
            }

            if (!numberOfSections || numberOfSections < 1 || numberOfSections > 10) {
                messageDiv.innerHTML = 'Please enter a valid number of sections (1-10)';
                messageDiv.className = 'modal-message error-message';
                console.log('Validation failed: Invalid section count');
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                messageDiv.innerHTML = 'Please upload an Excel file with student names';
                messageDiv.className = 'modal-message error-message';
                console.log('Validation failed: No file selected');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('programId', programId);
            formData.append('sessionName', badgeName);
            formData.append('numberOfSections', numberOfSections);
            formData.append('file', file);

            console.log('FormData created, sending request...');

            try {
                messageDiv.innerHTML = 'Creating badge, sections, and adding students... Please wait.';
                messageDiv.className = 'modal-message';

                const response = await fetch('/Manage/UploadBadgeStudents', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response received:', response.status, response.statusText);

                const result = await response.text();
                console.log('Result from server:', result);

                if (result === "Ok") {
                    messageDiv.innerHTML = 'Badge created successfully! Sections and students have been added.';
                    messageDiv.className = 'modal-message success-message';

                    // Reset form
                    document.getElementById("badgeProgramSelect").value = '';
                    document.getElementById("badgeName").value = '';
                    document.getElementById("numberOfSections").value = '4';
                    document.getElementById("badgeExcelFile").value = '';

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addBadgeModal'));
                        if (modal) {
                            modal.hide();
                        }
                        messageDiv.innerHTML = '';

                        // Refresh search if there's a search term
                        if (currentSearchTerm !== "") {
                            searchBadges();
                        } else {
                            // Show success message
                            showAlert('Badge created successfully!',"success");
                        }
                    }, 2000);
                } else {
                    // Show the specific error message
                    messageDiv.innerHTML = 'Error: ' + result;
                    messageDiv.className = 'modal-message error-message';
                    console.error('Server returned error:', result);
                }
            } catch (error) {
                console.error('Create badge error:', error);
                messageDiv.innerHTML = 'Error creating badge: ' + error.message;
                messageDiv.className = 'modal-message error-message';
            }
        }

        async function deleteBadge(sessionId, sessionName) {
            if (!confirm(`Are you sure you want to delete the badge "${sessionName}"? This will delete ALL associated sections and students!`)) {
                return;
            }

            try {
                const response = await fetch('/Manage/DeleteBadge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `sessionId=${sessionId}`
                });

                const result = await response.text();
                if (result === "Ok") {
                    // Remove badge card from UI
                    const badgeCard = document.getElementById(`badge-${sessionId}`);
                    if (badgeCard) {
                        badgeCard.remove();
                    }

                    // Check if any badges left
                    const remainingBadges = document.querySelectorAll('.badge-card');
                    if (remainingBadges.length === 0) {
                        showNoResults();
                    }

                    showAlert('Badge deleted successfully!',"success");
                } else {
                    showAlert('Error deleting badge: ' + result,"danger");
                }
            } catch (error) {
                console.error('Delete badge error:', error);
                showAlert('Error deleting badge. Please try again.',"danger");
            }
        }

        // Clear modal when closed
        document.getElementById('addBadgeModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById("addBadgeMessage").innerHTML = '';
            document.getElementById("badgeProgramSelect").value = '';
            document.getElementById("badgeName").value = '';
            document.getElementById("numberOfSections").value = '4';
            document.getElementById("badgeExcelFile").value = '';
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            hideAllResults();
        });
    </script>
</body>
</html>